<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

        <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin=""/>

        <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>

        <style>
            html {
                font-family: 'Raleway', sans-serif;
            }

            #full-map {
                width: 100%;
                height: 200px;
            }

            .info {
                padding: 6px 8px;
                font-size: 14px;
                background: rgba(255,255,255,0.8);
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
                border-radius: 5px;
            }

            .info h4 {
                margin: 0 0 5px;
                color: #777;
            }

            .legend {
                text-align: left;
                line-height: 18px;
                color: #555;
            }

            .legend i {
                width: 18px;
                height: 18px;
                float: left;
                margin-right: 8px;
                opacity: 0.7;
            }
        </style>
    </head>
    <body>
        <div id="full-map"></div>
        <footer>Made with love in Florence</footer>

        <script>
            const WaitingTimesAPI = {
                geocodeAPI: 'https://api-geo.thejoin.tech/geocode?lat=%s&lng=%s',
                getPlacesAPI: 'https://api-geo.thejoin.tech/places/explore?q=%s&address=%s',
                format: function (str) {
                    var args = [].slice.call(arguments, 1),
                        i = 0;

                    return str.replace(/%s/g, () => args[i++]);
                }
            };

            const TimesApp = {
                lat: null,
                lng: null,
                address: "",
                zoom: 14,
                lMap: null,
                myPosition: null,
                query: "supermarket",
                place_ids: [],
                initMap: function () {
                    TimesApp.lMap = L.map('full-map').setView([TimesApp.lat, TimesApp.lng], TimesApp.zoom);
                    L.tileLayer(
                        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 18,
                            attribution: 'Map data <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
                        }
                    ).addTo(TimesApp.lMap);

                    TimesApp.lMap.zoomControl.remove()

                    TimesApp.myPosition = L.circle([TimesApp.lat, TimesApp.lng], {
                        color: '#0696c1',
                        fillColor: '#06aee0',
                        fillOpacity: 0.5,
                        radius: 50
                    }).bindPopup("Your position").addTo(TimesApp.lMap);

                    TimesApp.lMap.on("moveend", async function () {
                        let center = TimesApp.lMap.getCenter();
                        console.log("new center ", center.toString());
                        TimesApp.lat = center.lat;
                        TimesApp.lng = center.lng;
                        await TimesApp.updateAddress(-1);
                    });
                    
                    TimesApp.showLegend();
                    TimesApp.getPlaces();
                },
                getMarkerPlaceColor: function (d) {
                    return d > 60 ? ['#BD0026', '#cc0c33'] :
                        d > 45  ? ['#800026', '#ff2929'] :
                        d > 30  ? ['#e33c17', '#fa4c25'] :
                        d > 25  ? ['#de691b', '#fc7e2a'] :
                        d > 15   ? ['#e6a910', '#ffbf1c'] :
                        d > 10   ? ['#d9e30e', '#ecf716'] :
                                    ['#1dbd00', '#1fcc00'];
                },
                showLegend: function () {
                    var legend = L.control({position: 'bottomright'});

                    legend.onAdd = function (map) {

                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [5, 10, 15, 25, 30, 45, 60],
                            labels = [],
                            from, to;

                        for (var i = 0; i < grades.length; i++) {
                            from = grades[i];
                            to = grades[i + 1];

                            labels.push(
                                '<i style="background:' + TimesApp.getMarkerPlaceColor(grades[i]+1)[1] + '"></i> ' +
                                from + (to ? '&ndash;' + to : '+'));
                        }

                        div.innerHTML = labels.join('<br>');
                        return div;
                    };

                    legend.addTo(TimesApp.lMap);
                },
                getWaitTime: function (place) {
                    const hour = (new Date()).getHours();
                    const weekDay = ((new Date()).getDay() === 0) ? 6 : (new Date()).getDay() - 1;
                    const maxTimeSpent = Math.max(...place["time_spent"]) || 0;
                    const meanTimeSpent = (place["time_spent"][0] + place["time_spent"][1]) / 2 || 0;
                    const cPopularity = place["current_popularity"] || 15;

                    var waitTimes, popTimes = 15;
                    if (place["time_wait"] !== undefined)
                        waitTimes = place["time_wait"][weekDay]["data"][hour];
                    
                    popTimes = place["populartimes"][weekDay]["data"][hour];

                    console.log("maxSpent: %d, cPop: %d, wait: %d, popTimes: %d", maxTimeSpent, cPopularity, waitTimes, popTimes);
                    console.log("wait_times+timespent: ", (waitTimes+maxTimeSpent+popTimes));
                    console.log("radius: ", (waitTimes + meanTimeSpent + cPopularity));
                    return Math.ceil(waitTimes + meanTimeSpent);
                },
                getPlaces: function () {
                    fetch(WaitingTimesAPI.format(WaitingTimesAPI.getPlacesAPI, TimesApp.query, TimesApp.address))
                        .then((r) => { if (r.ok) return r.json(); })
                        .then((places) => TimesApp.setPlaceOnMap(places));
                },
                setPlaceOnMap: function (places) {
                    console.log(places);
                    for (const key in places) {
                        if (places[key]["populartimes"] === undefined || TimesApp.place_ids.indexOf(places[key]["place_id"]) !== -1) continue;
                        
                        let waitTime = TimesApp.getWaitTime(places[key]) || 20;
                        let radius = waitTime + 80;
                        let colors = TimesApp.getMarkerPlaceColor(waitTime);
                        
                        const circleMarker = L.circle([places[key]["coordinates"]["lat"], places[key]["coordinates"]["lng"]], {
                            color: colors[0],
                            fillColor: colors[1],
                            fillOpacity: 0.5,
                            radius: radius
                        });

                        const pointMarker = L.marker([places[key]["coordinates"]["lat"], places[key]["coordinates"]["lng"]]);
                        
                        circleMarker.bindPopup(places[key]["name"] + " " + waitTime + "min of line");
                        circleMarker.addTo(TimesApp.lMap);
                        
                        pointMarker.bindPopup(places[key]["name"] + " " + waitTime + "min of line");
                        pointMarker.addTo(TimesApp.lMap);
                        
                        TimesApp.place_ids.push(places[key]["place_id"]);
                    }
                },
                updateAddress: async function (initMap) {
                    initMap = initMap || true;
                    fetch(WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPI, TimesApp.lat, TimesApp.lng))
                        .then((r) => { if (r.ok) return r.json(); })
                        .then((r) => { 
                            r.staddress = (typeof(r.staddress) === 'object') ? '' : r.staddress;
                            r.city = (typeof(r.city) === 'object') ? '' : r.city;

                            TimesApp.address = r.staddress + ', ' + r.city;
                            (initMap === true) ? TimesApp.initMap() : TimesApp.getPlaces();
                        });
                },
                geoSuccess: async function (position) {
                    TimesApp.lat = position.coords.latitude;
                    TimesApp.lng = position.coords.longitude;

                    await TimesApp.updateAddress();
                    // TimesApp.initMap();
                },
                geoError: function () {
                    TimesApp.address = prompt("This app need your gps position or at least your address or your city:", "").trim();
                    if (address != "") {
                        fetch("https://geocode.xyz/" + TimesApp.address + "?json=1")
                            .then((r) => { if (r.ok) r.json(); })
                            .then((r) => {
                                TimesApp.lat = r.latt;
                                TimesApp.lng = r.lngt;
                                TimesApp.initMap();
                            });
                    }
                }
            };

            document.addEventListener('DOMContentLoaded', function () {
                const mapEl = document.getElementById('full-map');
                mapEl.style.height = window.innerHeight - 50 + 'px';
                
                navigator.geolocation.getCurrentPosition(TimesApp.geoSuccess, TimesApp.geoError);
            });
        </script>
    </body>
</html>